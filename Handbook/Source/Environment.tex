% This is part of the Avaneya Crew Handbook.
% Copyright (C) 2010, 2011
%   Kshatra Corp.
% See the file License for copying conditions.

% The environment file is used to setup the typesetting that relate to 
%  any product, but at present, just the handbook...

\startenvironment Environment

% Speedup typescripting considerably at the cost of using additional memory...
\preloadtypescripts

\usemodule[units,simplefonts]

% Define colours...
\definecolor[colour_text][r=.754,g=.516,b=.324]
\definecolor[colour_head][r=.828,g=.313,b=.176]
\definecolor[colour_item][r=.864,g=.426,b=.234]
\definecolor[colour_link][colour_head]
\definecolor[colour_figure_border][colour_head]
\definecolor[colour_frame_border][colour_text]
\definecolor[colour_page][r=0,g=0,b=0]
\definecolor[colour_page_number][colour_head]
\definecolor[colour_footnote_text][colour_text]
\definecolor[colour_footnote_background][colour_page]
\definecolor[colour_table_row_odd][r=.1,g=.1,b=.1]
\definecolor[colour_table_row_even][r=.115,g=.115,b=.115]

% Bzr version...
\def\BazaarRevision{\cldcontext{os.resultof"bzr revno | tr -d '\\n'"}}

% Setup PDF metadata...
\setupinteraction
  [state=start,
   color=colour_link,
   contrastcolor=colour_link,
   focus=standard, % Clicking an inter-document hyperlink by default switches to "fit page" mode. Override.
   title=Avaneya Crew Handbook,
   subtitle=A guidebook for new and current contributors.,
   author=The Avaneya Crew from Bazaar revision \BazaarRevision.,
   keyword={Avaneya, handbook, Mars, GNU, game}]

\setupTABLE[row][odd][background=color,backgroundcolor=colour_table_row_odd]
\setupTABLE[row][even][background=color,backgroundcolor=colour_table_row_even]

\setupexternalfigures
  [frame=on,
   corner=rectangular,
   framecolor=colour_figure_border,
   background=color, 
   backgroundcolor=colour_page,
   rulethickness=1pt]

\setupurl
  [color=colour_link,
   style=\bf]

\setupframedtexts
  [framecolor=colour_frame_border]

% Show the PDF bookmarks and expand to the chapter and section level...
\placebookmarks[chapter,section,subsection,subsubsection][chapter]
\setupinteractionscreen[option=bookmark]

\setupbackgrounds
   [rightpage]
   [background=color,backgroundcolor=colour_page]

% Set PDF compression level, default is 3, so set to maximum...
\setupbackend
  [level=9]

\setupsystem
  [random=big]

\unprotect
\setuplayout
  [location=middle,
   style=\ss,
   backspace=2.5cm,
   topspace=1.5cm,
   width=16cm,
   margindistance=.25cm,
   margin=2.5cm,
   height=middle]

\definelayout
  [fullpage]
  [backspace=0pt,
   topspace=0pt,
   width=middle,
   height=middle,
   header=0pt,
   footer=0pt]
\protect

\definepapersize[main][A4][A4]
\definepapersize[diagram][A4,landscape][A4,landscape]

% Remove surrounding quotation marks on references...
\setupreferencing[left=, right=]

\definefontsynonym[chapternumberfont][RegularBold]
\definefontsynonym[chaptertextfont]  [RegularBold]

\definebodyfont[11pt][rm][bfe=RegularBold at 30pt]
\definebodyfont[11pt][rm][bft=RegularBold at 30pt]

\setmainfont[Ubuntu]
\setupbodyfont[11pt]

\def\CopyrightDates{2010, 2011}
\def\CopyrightHolder{Kshatra Corp}

% Insert a full page landscape diagram, parameters are node name, caption, and path...
\def\FullPageLandscapeDiagram#1#2#3%
{
    \page 
    \setuppapersize[diagram]
    \setuplayout[fullpage]
    \startframedtext[width=.95\textwidth,bottom=\vss,top=\vss,align=right,corner=rectangular]
    \placefigure
        [force][figure:#1]
        {#2}
        {\externalfigure[#3][width=.95\textwidth]}
    \stopframedtext
    \page
    \setuppapersize[main]
    \setuplayout[reset]
}

\def\StartChapter#1%
{
    \startcomponent{#1}
    \chapter[#1]{#1}
%    \index{#1}
}

\def\StopChapter%
{
    \stopcomponent
}

\def\StartSection#1%
{
    \section[#1]{#1}
%    \index{#1}
}

\def\StartSubSection#1%
{
    \subsection[#1]{#1}
%    \index{#1}
}

\def\StartSubSubSection#1%
{
    \subsubsection[#1]{#1}
%    \index{#1}
}

\def\StartTimelineDate#1%
{
    \subsubsubject{\bf #1}
}

\def\StopTimelineDate%
{
    \crlf
}

\definestartstop
    [TimelineDocument]
    [before={
        \setupbackground[frame=on,
                         before=\blank,
                         after=\blank,
                         corner=round,
                         topoffset=0.5cm,
                         leftoffset=0.5cm,
                         rightoffset=0.5cm,
                         bottomoffset=0.5cm]
        \startbackground
            },
     after=\stopbackground,
     commands={\setupalign[yes]},
     style=italic]

% Usage: \href{http://www.someurl.com}{Text}
\def\href#1#2{\useURL[#2][{#2}][][{#1}]\goto{\url[#2]}[url(#1)]}

\def\ahref#1{\color[colour_link]{\ttx \href{#1}{<#1>}}}

\def\fullahref#1{\color[colour_link]{\ttx \href{#1}{#1}}}

\def\mailto#1{\useURL[#1][mailto:#1][][#1]\from[{#1}]}

\def\MailTo#1#2{\useURL[#1][mailto:#1][][#2]\from[{#1}]}

\definestartstop
    [CodeExample]
    [before={
        \crlf
        \setupbackground[frame=on,
                         before=\blank,
                         after=\blank,
                         corner=round,
                         topoffset=0.5cm,
                         leftoffset=0.5cm,
                         rightoffset=0.5cm,
                         bottomoffset=0.5cm]
        \startbackground
        \startlines
            },
     after={
        \stoplines
        \stopbackground
        \crlf
           },
     commands={\setupalign[right]},
     style=type]

\defineframedtext
  [MiniFile]
  [width=25em,
   offset=0.25ex,
   bodyfont=7pt,
   background=color,
   backgroundcolor=colour_page,
   backgroundoffset=.25ex,
   frame=off,
   before=,
   after=]

% Number formulae etc. using the chapter number...
\setupnumbering
    [way=bychapter]

\setuppagenumbering
  [location=top,
   way=bytext,
   left={\lettertilde\space},right={\space\lettertilde},
   color=colour_page_number,
   style=bold]

\setuptolerance
  [verytolerant,stretch]

\setupblank
  [medium]

\setupwhitespace
  [medium]

\setuptyping
  [blank=medium]

\setupfootertexts
  [margin]
  [][{
\hfill
%\doifnotmode{*frontpart}{\getmarking[chapternumber]}
\hfill
    }]

\setupbodyfontenvironment
  [default]
  [em=italic]

\setupsectionblock[frontpart] [page=yes]
\setupsectionblock[bodypart]  [page=yes]
\setupsectionblock[appendix]  [page=yes]
\setupsectionblock[frontpart] [before=,after=]

\setupfootnotes
  [color=colour_footnote_text,
   backgroundcolor=colour_footnote_background]

\setuphead
  [chapter]
  [command=\PlaceSection,
   color=colour_head,
   page=yes,
   before=,
   header=nomarking,
   style=\bfd]

\setuphead
  [title]
  [command=\PlaceSection,
   color=colour_head,
   page=right,
   before=,
   header=nomarking,
   style=\bfd]

\setuphead
  [section]
  [command=\PlaceSection,
   color=colour_head,
   inbetween=,
   style=\bfb]

\setuphead
  [subsection]
  [command=\PlaceSection,
   color=colour_head,
   before=\crlf,
   style=\bfa]

\setuphead
  [subsubsection]
  [command=\PlaceSection,
   color=colour_head,
   before=\blank,
   style=\bsa]

\def\PlaceSection#1#2%
  {\goodbreak
   \vbox
     {\localheadsetup
      \begstrut
      \inleftmargin{\hbox to \leftmarginwidth{\hss#1\hss}}%
      #2}}

\setupcaptions[location=bottom]

\setuptype
  [option=slanted]

\setuptyping
  [option=slanted]

\setuplist
  [section]
  [width=3em]

\defineregister
  [texmacro]
  [texmacros]

\setupregister
  [texmacro]
  [indicator=off,
   distance=1em minus .25em]

\setupfootnotes
  [rule=on]

\setuphead
  [chapter]
  [header=empty]

\setupitemize
  [each][fit,broad,color=colour_item][distance=.25em]

\setupitemgroup[itemize]
  [each]
  [headstyle=bold]

\setupitemgroup[itemize]
  [each]
  [stopper]

\setupsubpagenumber
  [way=bychapter,
   state=start]

\stopenvironment

