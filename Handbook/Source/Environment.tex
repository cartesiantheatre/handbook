% This is part of the Avaneya Crew Handbook.
% Copyright (C) 2010, 2011
%   Kshatra Corp.
% See the file License for copying conditions.

% The environment file is used to setup the typesetting that relate to 
%  any product, but at present, just the crew handbook...

\startenvironment Environment

% Speedup typescripting considerably at the cost of using additional memory...
\preloadtypescripts

\usemodule[units,simplefonts]

% Setup PDF metadata...
\setupinteraction
  [state=start,
   color=red,
   title=Avaneya Crew Handbook,
   subtitle=A guidebook for new and current contributors. Bazaar revision \cldcontext{os.resultof"bzr revno | tr -d '\\n'"}.,
   author=The Avaneya Crew,
   keyword={Avaneya, handbook, Mars, GNU, game}]

% Show the PDF bookmarks and expand to the chapter and section level...
\placebookmarks[chapter,section,subsection,subsubsection][chapter]
\setupinteractionscreen[option=bookmark]

\setupbackgrounds
   [rightpage]
   [background=]

% Set PDF compression level, default is 3, so set to maximum...
\setupbackend
  [level=9]

\setupsystem
  [\c!random=\v!big]

\setuplayout
  [\c!location=\v!middle,
   \c!style=\ss,
   \c!backspace=2.5cm,
   \c!topspace=1.5cm,
   \c!width=16cm,
   \c!margindistance=.25cm,
   \c!margin=2.5cm,
   \c!height=\v!middle]

\definefontsynonym[chapternumberfont][RegularBold]
\definefontsynonym[chaptertextfont]  [RegularBold]

\definebodyfont[11pt][rm][bfe=RegularBold at 30pt]
\definebodyfont[11pt][rm][bft=RegularBold at 30pt]

\setmainfont[Ubuntu]
\setupbodyfont[11pt]

\definelayout
  [fullpage]
  [\c!backspace=0pt,
   \c!topspace=0pt,
   \c!width=\v!middle,
   \c!height=\v!middle,
   \c!header=0pt,
   \c!footer=0pt]

\definepapersize[main][A4][A4]
\definepapersize[diagram][A4,landscape][A4,landscape]

\def\CopyrightDates{2010, 2011}
\def\CopyrightHolder{Kshatra Corp}

\def\StartChapter#1%
{
    \startcomponent{#1}
    \chapter[#1]{#1}
    \index{#1}
}

\def\StopChapter%
{
    \stopcomponent
}

\def\StartSection#1%
{\section[#1]{#1}\index{#1}}

\def\StartSubSection#1%
{\subsection[#1]{#1}\index{#1}}

\def\StartSubSubSection#1%
{\subsubsection[#1]{#1}\index{#1}}

\def\StartTimelineDate#1%
{\subsubsubject{\bf #1}}

\def\StopTimelineDate%
{
\crlf
}

\def\StartTimelineDocument%
{
\crlf
\startframedtext[width=broad,bottom=\vss,top=\vss,align=right,corner=round]
\it 
}

\def\StopTimelineDocument%
{
\stopframedtext
\crlf
}

% Usage: \href{http://www.someurl.com}{Text}
\def\href#1#2{\useURL[#2][{#2}][][{#1}]\goto{\url[#2]}[url(#1)]}

\def\ahref#1{\color[linkcolor]{\ttx \href{#1}{<#1>}}}

\def\fullahref#1{\color[linkcolor]{\ttx \href{#1}{#1}}}

\def\mailto#1{\useURL[#1][mailto:#1][][#1]\from[{#1}]}

\def\MailTo#1#2{\useURL[#1][mailto:#1][][#2]\from[{#1}]}

\def\StartCodeExample%
{
\blank
\startframedtext[width=broad,bottom=\vss,top=\vss,align=right,corner=round]
\startlines
\tt
}

\def\StopCodeExample%
{
\stoplines
\stopframedtext
\blank
}

\def\startexample
  {\blank
   \begingroup}

\def\stopexample
  {\endgroup
   \blank}

\def\startreality
  {\blank
   \page[\v!preference]
   \begingroup}

\def\stopreality
  {\relax
   \endgroup
   \blank}

\defineframedtext
  [MiniFile]
  [\c!width=25em,
   \c!offset=0.25ex,
   \c!bodyfont=7pt,
   \c!background=\v!color,
   \c!backgroundcolor=GrayColor,
   \c!backgroundoffset=.25ex,
   \c!frame=\v!off,
   \c!before=,
   \c!after=]

% Number formulae etc. using the chapter number...
\setupnumbering
    [way=bychapter]

\setuppagenumbering
  [\c!location=]

\setuptolerance
  [\v!verytolerant,\v!stretch]

\setupblank
  [\v!medium]

\setupwhitespace
  [\v!medium]

\setuptyping
  [\c!blank=\v!medium]

\setupheadertexts
  [\v!margin]
  [][\hfill\pagenumber\hfill]

\setupfootertexts
  [\v!margin]
  [][{\hfill\doifnotmode{*\v!frontpart}{\getmarking[\v!chapter\v!number]}\hfill}]

\setupheadertexts
  [\v!text]
  [][{\hfill\getmarking[\v!chapter]\hfill}]

%\setupfootertexts
%  [\v!text]
%  [][{\hfill\getmarking[\v!section]\hfill}]

\setupbodyfontenvironment
  [default]
  [em=italic]

\setupsectionblock[\v!frontpart] [\c!page=\v!yes]
\setupsectionblock[\v!bodypart]  [\c!page=\v!yes]
\setupsectionblock[\v!appendix]  [\c!page=\v!yes]
\setupsectionblock[\v!frontpart] [\c!before=,\c!after=]

\setuphead
  [\v!chapter]
  [\c!command=\PlaceSection,
   \c!page=\v!yes,
   \c!before=,
   \c!header=\v!nomarking,
   \c!style=\bfd]

\setuphead
  [\v!title]
  [\c!command=\PlaceSection,
   \c!page=\v!right,
   \c!before=,
   \c!header=\v!nomarking,
   \c!style=\bfd]

\setuphead
  [\v!section]
  [\c!command=\PlaceSection,
   \c!inbetween=,
   \c!style=\bfb]

\setuphead
  [\v!subsection]
  [\c!command=\PlaceSection,
   \c!before=\blank,
   \c!style=\bfa]

\setuphead
  [\v!subsubsection]
  [\c!command=\PlaceSection,
   \c!before=\blank,
   \c!style=\bsa]

\def\PlaceSection#1#2%
  {\goodbreak
   \vbox
     {\localheadsetup
      \begstrut
      \inleftmargin{\hbox to \leftmarginwidth{\hss#1\hss}}%
      #2}}

\setupcaptions[width=14cm,align=right]

\setMPtext{text}{some test text}

\startusableMPgraphic{text}
  picture r ;
  r := image ( graphictext
    \MPstring{text}
    randomized .4pt
    scaled 6pt
    withfillcolor .8\MPcolor{maincolor}
    withpen pencircle scaled 1pt ; ) ;
  draw r ;
\stopusableMPgraphic

\setuptype
  [\c!option=\v!slanted]

\setuptyping
  [\c!option=\v!slanted]

\setuplist
  [\v!section]
  [\c!width=3em]

\defineregister
  [texmacro]
  [texmacros]

\setupregister
  [texmacro]
  [\c!indicator=\v!off,
   \c!distance=1em minus .25em]

\setupfootnotes
  [\c!rule=\v!on]

\setuphead
  [\v!chapter]
  [\c!header=\v!empty]

\setupitemgroup[\v!itemize]
  [\v!each]
  [\c!headstyle=\v!bold]

\setupitemgroup[\v!itemize]
  [\v!each]
  [\v!stopper]

\setupsubpagenumber
  [\c!way=\v!by\v!chapter,
   \c!state=\v!start]

\stopenvironment

